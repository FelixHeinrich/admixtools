<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Using admixtools in R • admixtools</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/cosmo/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/all.min.css" integrity="sha256-nAmazAk6vS34Xqo0BSrTb+abbtFlgsFK7NKSi6o7Y78=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/v4-shims.min.css" integrity="sha256-6qHlizsOWFskGlwVOKuns+D1nB6ssZrHQrNj1wGplHc=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/headroom.min.js" integrity="sha256-DJFC1kqIhelURkuza0AvYal5RxMtpzLjFhsnVIeuk+U=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><!-- docsearch --><script src="../docsearch.js"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/docsearch.js/2.6.1/docsearch.min.css" integrity="sha256-QOSRU/ra9ActyXkIBbiIB144aDBdtvXBcNc3OTNuX/Q=" crossorigin="anonymous">
<link href="../docsearch.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/jquery.mark.min.js" integrity="sha256-4HLtjeVgH0eIB3aZ9mLYF6E8oU5chNdjU6p6rrXpl9U=" crossorigin="anonymous"></script><meta property="og:title" content="Using admixtools in R">
<meta property="og:description" content="">
<meta property="og:image" content="/logo.png">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-155330476-1"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-155330476-1');
</script>
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">admixtools</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.1.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/admixtools.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/plotting.html">Plotting</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
<form class="navbar-form navbar-right hidden-xs hidden-sm" role="search">
        <div class="form-group">
          <input type="search" class="form-control" name="search-input" id="search-input" placeholder="Search..." aria-label="Search for..." autocomplete="off">
</div>
      </form>
      
    </div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>Using admixtools in R</h1>
            
      
      
      <div class="hidden name"><code>admixtools.Rmd</code></div>

    </div>

    
    
<p>For the examples below the following R packages need to be loaded.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(admixtools)</a>
<a class="sourceLine" id="cb1-2" data-line-number="2"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(magrittr)</a>
<a class="sourceLine" id="cb1-3" data-line-number="3"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(tidyverse)</a></code></pre></div>
<p>If you have access to pre-computed f2-statistics, you can use them to compute f3 and f4 statistics, admixture weights, and to fit admixture graphs. The following examples should work on O2. The examples are just there to illustrate the principle, the models themselves don’t make too much sense.</p>
<p><br></p>
<div id="qp3pop" class="section level2">
<h2 class="hasAnchor">
<a href="#qp3pop" class="anchor"></a>qp3Pop</h2>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" data-line-number="1">pop1 =<span class="st"> 'Denisova.DG'</span></a>
<a class="sourceLine" id="cb2-2" data-line-number="2">pop2 =<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">'Altai_Neanderthal.DG'</span>, <span class="st">'Vindija.DG'</span>)</a>
<a class="sourceLine" id="cb2-3" data-line-number="3">pop3 =<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">'Chimp.REF'</span>, <span class="st">'Mbuti.DG'</span>, <span class="st">'Russia_Ust_Ishim.DG'</span>)</a></code></pre></div>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" data-line-number="1">f2_dir =<span class="st"> '/n/groups/reich/robert/projects/admixprograms/f2blocks_v42.1/'</span></a>
<a class="sourceLine" id="cb3-2" data-line-number="2"><span class="kw"><a href="../reference/qp3pop.html">qp3pop</a></span>(f2_dir, pop1, pop2, pop3)</a></code></pre></div>
<pre><code>## # A tibble: 6 x 7
##   pop1        pop2                 pop3                  est      se     z     p
##   &lt;chr&gt;       &lt;chr&gt;                &lt;chr&gt;               &lt;dbl&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
## 1 Denisova.DG Altai_Neanderthal.DG Chimp.REF          0.0459 4.81e-4  95.5     0
## 2 Denisova.DG Altai_Neanderthal.DG Mbuti.DG           0.0560 5.19e-4 108.      0
## 3 Denisova.DG Altai_Neanderthal.DG Russia_Ust_Ishim.… 0.0577 5.60e-4 103.      0
## 4 Denisova.DG Vindija.DG           Chimp.REF          0.0461 4.75e-4  97.2     0
## 5 Denisova.DG Vindija.DG           Mbuti.DG           0.0563 5.08e-4 111.      0
## 6 Denisova.DG Vindija.DG           Russia_Ust_Ishim.… 0.0583 5.55e-4 105.      0</code></pre>
<p><br></p>
</div>
<div id="qpdstat" class="section level2">
<h2 class="hasAnchor">
<a href="#qpdstat" class="anchor"></a>qpDstat</h2>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" data-line-number="1">pop4 =<span class="st"> 'Switzerland_Bichon.SG'</span></a></code></pre></div>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb6-1" data-line-number="1"><span class="kw"><a href="../reference/qpdstat.html">qpdstat</a></span>(f2_dir, pop1, pop2, pop3, pop4)</a></code></pre></div>
<pre><code>## # A tibble: 6 x 8
##   pop1     pop2        pop3       pop4             est      se       z         p
##   &lt;chr&gt;    &lt;chr&gt;       &lt;chr&gt;      &lt;chr&gt;          &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;     &lt;dbl&gt;
## 1 Denisov… Altai_Nean… Chimp.REF  Switzerlan…  1.16e-2 3.65e-4  31.9   1.88e-223
## 2 Denisov… Altai_Nean… Mbuti.DG   Switzerlan…  1.58e-3 2.76e-4   5.72  1.04e-  8
## 3 Denisov… Altai_Nean… Russia_Us… Switzerlan… -1.68e-4 2.93e-4  -0.575 5.65e-  1
## 4 Denisov… Vindija.DG  Chimp.REF  Switzerlan…  1.20e-2 3.76e-4  31.9   1.14e-222
## 5 Denisov… Vindija.DG  Mbuti.DG   Switzerlan…  1.81e-3 2.83e-4   6.39  1.67e- 10
## 6 Denisov… Vindija.DG  Russia_Us… Switzerlan… -1.86e-4 3.04e-4  -0.614 5.39e-  1</code></pre>
<p><br></p>
</div>
<div id="qpadm" class="section level2">
<h2 class="hasAnchor">
<a href="#qpadm" class="anchor"></a>qpAdm</h2>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb8-1" data-line-number="1">target =<span class="st"> 'Denisova.DG'</span></a>
<a class="sourceLine" id="cb8-2" data-line-number="2">left =<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">'Altai_Neanderthal.DG'</span>, <span class="st">'Vindija.DG'</span>)</a>
<a class="sourceLine" id="cb8-3" data-line-number="3">right =<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">'Chimp.REF'</span>, <span class="st">'Mbuti.DG'</span>, <span class="st">'Russia_Ust_Ishim.DG'</span>, <span class="st">'Switzerland_Bichon.SG'</span>)</a></code></pre></div>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb9-1" data-line-number="1"><span class="kw"><a href="../reference/qpadm.html">qpadm</a></span>(f2_dir, target, left, right)</a></code></pre></div>
<pre><code>## ℹ Computing f4 stats...
## ℹ Computing admixture weights...
## ℹ Computing standard errors...
## ℹ Computing number of admixture waves...</code></pre>
<pre><code>## $weights
## # A tibble: 2 x 5
##   target      left                 weight    se     z
##   &lt;chr&gt;       &lt;chr&gt;                 &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
## 1 Denisova.DG Altai_Neanderthal.DG   50.2  24.0  2.10
## 2 Denisova.DG Vindija.DG            -49.2  24.0 -2.06
## 
## $rankdrop
## # A tibble: 1 x 7
##   f4rank   dof chisq      p dofdiff chisqdiff p_nested
##    &lt;int&gt; &lt;int&gt; &lt;dbl&gt;  &lt;dbl&gt;   &lt;int&gt;     &lt;dbl&gt;    &lt;dbl&gt;
## 1      1     2  7.14 0.0281      NA        NA       NA
## 
## $popdrop
## # A tibble: 1 x 13
##   pat      wt   dof chisq      p f4rank Altai_Neanderth… Vindija.DG feasible
##   &lt;chr&gt; &lt;dbl&gt; &lt;int&gt; &lt;dbl&gt;  &lt;dbl&gt;  &lt;int&gt;            &lt;dbl&gt;      &lt;dbl&gt; &lt;lgl&gt;   
## 1 00        0     2  7.14 0.0281      1             50.2      -49.2 FALSE   
## # … with 4 more variables: best &lt;lgl&gt;, dofdiff &lt;int&gt;, chisqdiff &lt;dbl&gt;,
## #   p_nested &lt;dbl&gt;</code></pre>
<div id="caveats" class="section level3">
<h3 class="hasAnchor">
<a href="#caveats" class="anchor"></a>Caveats</h3>
<p>This function only reports <code>qpAdm</code> admixture weights, and doesn’t determine the number of independent source populations. The <code>qpadm</code> function also hasn’t been tested as much as the <code>qpgraph</code> function, and doesn’t always give accurate results.</p>
<p><br></p>
</div>
</div>
<div id="qpgraph" class="section level2">
<h2 class="hasAnchor">
<a href="#qpgraph" class="anchor"></a>qpGraph</h2>
<p>The f2-statistics can also be used to fit an admixture graph to the data.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb12-1" data-line-number="1">qpg_results =<span class="st"> </span><span class="kw"><a href="../reference/qpgraph.html">qpgraph</a></span>(f2_dir, example_graph, <span class="dt">f2_denom =</span> <span class="fl">0.278</span>)</a></code></pre></div>
<p>Here, <code>example_graph</code> is a specific graph included in this R package, but you can provide any other graph in one of three formats.</p>
<ol style="list-style-type: decimal">
<li>An <a href="https://igraph.org/r/"><code>igraph</code></a> object.</li>
<li>A two column matrix, where each row is an edge, the first column is the source of the edge, and the second column is the target.</li>
<li>The location of a <code>qpGraph</code> graph file, which will be read and parsed.</li>
</ol>
<p>The only requirements are that the graph is a valid admixture graph: a directed acyclic graph where each node has no more than two children, no more than two parents, and no more than three incident edges in total. The first edge should start at the root and end at the outgroup. There need to be f2 statistics for all leaf nodes.</p>
<p><br></p>
<p>The precomputed f2 statistics are not scaled, which it why it is necessary to set <code>f2_denom</code> to <code>0.278</code> to get matching results. Without that scaling, the absolute values may differ, but the relative values should still be ok.</p>
<p><br></p>
<p>The <code>qpgraph</code> output is a list with five items:</p>
<ol style="list-style-type: decimal">
<li>A data frame with estimated edge weights. This includes normal edges as well as admixture edges</li>
<li>The likelihood score. Smaller scores indicate a better fit</li>
<li>The estimated f2-statistics and standard errors for all population pairs</li>
<li>The estimated f3-statistics and standard errors for all population pairs with the outgroup</li>
<li>A data frame with details from the weight optimization, with one row per set of starting values</li>
</ol>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb13-1" data-line-number="1">qpg_results<span class="op">$</span>edges</a></code></pre></div>
<pre><code>## # A tibble: 27 x 4
##    from  to                   type   weight
##    &lt;chr&gt; &lt;chr&gt;                &lt;chr&gt;   &lt;dbl&gt;
##  1 R     Chimp.REF            edge  0.203  
##  2 R     N4N                  edge  0.203  
##  3 N0N   Altai_Neanderthal.DG edge  0.00766
##  4 N0N   N3N0                 edge  0.0292 
##  5 N1N   N0N                  edge  0.234  
##  6 N1N   N3N1                 edge  0.0981 
##  7 N2N0  N1N                  edge  0.106  
##  8 N2N0  N3N6                 edge  0.0428 
##  9 N2N1  Vindija.DG           edge  0      
## 10 N2N1  N2N3                 edge  0      
## # … with 17 more rows</code></pre>
<p><br></p>
<p>This works for any populations for which there are precomputed f2-statistics.</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb15-1" data-line-number="1">allpops =<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/list.files.html">list.dirs</a></span>(f2_dir, <span class="dt">full.names =</span> <span class="ot">FALSE</span>, <span class="dt">recursive =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb15-2" data-line-number="2">rand_pops =<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/sample.html">sample</a></span>(allpops, <span class="kw"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span>(<span class="dv">20</span>, <span class="kw"><a href="https://rdrr.io/r/base/length.html">length</a></span>(allpops)))</a>
<a class="sourceLine" id="cb15-3" data-line-number="3">rand_graph =<span class="st"> </span><span class="kw"><a href="../reference/random_admixturegraph.html">random_admixturegraph</a></span>(rand_pops, <span class="dt">numadmix =</span> <span class="dv">3</span>)</a>
<a class="sourceLine" id="cb15-4" data-line-number="4">rand_results =<span class="st"> </span><span class="kw"><a href="../reference/qpgraph.html">qpgraph</a></span>(f2_dir, rand_graph, <span class="dt">f2_denom =</span> <span class="fl">0.278</span>, <span class="dt">verbose =</span> <span class="ot">TRUE</span>)</a></code></pre></div>
<div id="caveats-1" class="section level3">
<h3 class="hasAnchor">
<a href="#caveats-1" class="anchor"></a>Caveats</h3>
<ul>
<li>A ‘fudge’ factor is added to the diagonal elements of the covariance matrix, to ensure that the matrix inversion is stable. This factor defaults to a relatively large value of 1e-3, to ensure that no error will be thrown in most cases. However, the original qpGraph uses 1e-5, which gives more accurate results in most cases. Increasing this factor seems to have a small effect on admixture weights and branch lengths, but a larger effect on the likelihood scores.</li>
<li>There may be differences in the results that originate in how missing data is treated. The precomputed f2 statistics on O2 use all SNPs, similar to <code>useallsnps YES</code>, while the examples here were computed on f2 statistics based only on SNPs with non-missing data in all populations (<code>na.action = 'remove'</code>), similar to <code>useallsnps NO</code>.</li>
</ul>
<p><br></p>
</div>
</div>
<div id="comparing-results-to-admixtools" class="section level2">
<h2 class="hasAnchor">
<a href="#comparing-results-to-admixtools" class="anchor"></a>Comparing results to AdmixTools</h2>
<p>There are wrapper function which call the origial <code>AdmixTools</code> programs and read the results. This can be used to check if the results of <code>qpgraph</code> are correct.</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb16-1" data-line-number="1">binpath =<span class="st"> '/home/np29/o2bin/'</span></a>
<a class="sourceLine" id="cb16-2" data-line-number="2">env =<span class="st"> 'export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:/n/app/openblas/0.2.19/lib/:/n/app/gsl/2.3/lib/;'</span></a>
<a class="sourceLine" id="cb16-3" data-line-number="3"></a>
<a class="sourceLine" id="cb16-4" data-line-number="4">qp3pop_bin  =<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(env, binpath, <span class="st">'qp3pop'</span>)</a>
<a class="sourceLine" id="cb16-5" data-line-number="5">qpdstat_bin =<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(env, binpath, <span class="st">'qpDstat'</span>)</a>
<a class="sourceLine" id="cb16-6" data-line-number="6">qpadm_bin   =<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(env, binpath, <span class="st">'qpAdm'</span>)</a>
<a class="sourceLine" id="cb16-7" data-line-number="7">qpgraph_bin =<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(env, binpath, <span class="st">'qpGraph'</span>)</a>
<a class="sourceLine" id="cb16-8" data-line-number="8"></a>
<a class="sourceLine" id="cb16-9" data-line-number="9"><span class="co">#prefix = '/n/groups/reich/DAVID/V42/V42.1/v42.1'</span></a>
<a class="sourceLine" id="cb16-10" data-line-number="10">prefix =<span class="st"> '/n/groups/reich/robert/projects/admixprograms/v42.1_small'</span></a>
<a class="sourceLine" id="cb16-11" data-line-number="11">outdir =<span class="st"> 'write/files/here/'</span></a>
<a class="sourceLine" id="cb16-12" data-line-number="12"></a>
<a class="sourceLine" id="cb16-13" data-line-number="13"><span class="kw"><a href="../reference/qp3pop_wrapper.html">qp3pop_wrapper</a></span>(<span class="dt">source1 =</span> pop2, <span class="dt">source2 =</span> pop3, <span class="dt">target =</span> pop1,</a>
<a class="sourceLine" id="cb16-14" data-line-number="14">               qp3pop_bin, prefix, outdir)</a>
<a class="sourceLine" id="cb16-15" data-line-number="15"><span class="kw"><a href="../reference/qpdstat_wrapper.html">qpdstat_wrapper</a></span>(pop1, pop2, pop3, pop4,</a>
<a class="sourceLine" id="cb16-16" data-line-number="16">                qpdstat_bin, prefix, outdir)</a>
<a class="sourceLine" id="cb16-17" data-line-number="17"><span class="kw"><a href="../reference/qpadm_wrapper.html">qpadm_wrapper</a></span>(target, left, right,</a>
<a class="sourceLine" id="cb16-18" data-line-number="18">              qpadm_bin, prefix, outdir)</a>
<a class="sourceLine" id="cb16-19" data-line-number="19"><span class="kw"><a href="../reference/qpgraph_wrapper.html">qpgraph_wrapper</a></span>(example_graph,</a>
<a class="sourceLine" id="cb16-20" data-line-number="20">                qpgraph_bin, prefix, outdir)</a></code></pre></div>
<p><strong>Unless <code>outdir</code> is specified, calling these wrapper functions may overwrite files in the working directory!</strong></p>
<p>If you already have existing parameter files and population or graph files, you can run the wrapper functions like this (though the different programs will require different parfiles and popfiles):</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb17-1" data-line-number="1"><span class="kw"><a href="../reference/qp3pop_wrapper.html">qp3pop_wrapper</a></span> (<span class="dt">parfile =</span> <span class="st">'parfile.txt'</span>, <span class="dt">bin =</span> qp3pop_bin)</a>
<a class="sourceLine" id="cb17-2" data-line-number="2"><span class="kw"><a href="../reference/qpdstat_wrapper.html">qpdstat_wrapper</a></span>(<span class="dt">parfile =</span> <span class="st">'parfile.txt'</span>, <span class="dt">bin =</span> qpdstat_bin)</a>
<a class="sourceLine" id="cb17-3" data-line-number="3"><span class="kw"><a href="../reference/qpadm_wrapper.html">qpadm_wrapper</a></span>  (<span class="dt">parfile =</span> <span class="st">'parfile.txt'</span>, <span class="dt">bin =</span> qpadm_bin)</a>
<a class="sourceLine" id="cb17-4" data-line-number="4"></a>
<a class="sourceLine" id="cb17-5" data-line-number="5"><span class="kw"><a href="../reference/qp3pop_wrapper.html">qp3pop_wrapper</a></span> (<span class="st">'popfile.txt'</span>, <span class="dt">bin =</span> qp3pop_bin,  <span class="dt">pref =</span> prefix)</a>
<a class="sourceLine" id="cb17-6" data-line-number="6"><span class="kw"><a href="../reference/qpdstat_wrapper.html">qpdstat_wrapper</a></span>(<span class="st">'popfile.txt'</span>, <span class="dt">bin =</span> qpdstat_bin, <span class="dt">pref =</span> prefix)</a>
<a class="sourceLine" id="cb17-7" data-line-number="7"></a>
<a class="sourceLine" id="cb17-8" data-line-number="8"><span class="kw"><a href="../reference/qpadm_wrapper.html">qpadm_wrapper</a></span>(<span class="dt">left =</span> <span class="st">'left.txt'</span>, <span class="dt">right =</span> <span class="st">'right.txt'</span>, <span class="dt">bin =</span> qpadm_bin, <span class="dt">pref =</span> prefix)</a>
<a class="sourceLine" id="cb17-9" data-line-number="9"></a>
<a class="sourceLine" id="cb17-10" data-line-number="10"><span class="kw"><a href="../reference/qpgraph_wrapper.html">qpgraph_wrapper</a></span>(<span class="st">'graphfile.txt'</span>, <span class="dt">parfile =</span> <span class="st">'parfile.txt'</span>, <span class="dt">bin =</span> qpgraph_bin)</a></code></pre></div>
<p><br></p>
<p>The following function makes it easy to compare qpGraph results.</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb18-1" data-line-number="1">qpgraph_ref_results =<span class="st"> </span><span class="kw"><a href="../reference/qpgraph_wrapper.html">qpgraph_wrapper</a></span>(example_graph, qpgraph_bin, prefix)</a></code></pre></div>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb19-1" data-line-number="1"><span class="kw"><a href="../reference/plot_comparison.html">plot_comparison</a></span>(qpg_results, qpgraph_ref_results)</a></code></pre></div>
<p><img src="admixtools_files/figure-html/unnamed-chunk-19-1.png" width="700"><br></p>
<p>There are at least a few examples where the results seem to be approximately correct.</p>
<p><strong>Please let me know if you find examples where the results are different!</strong></p>
<p><br></p>
</div>
<div id="computing-f2-statistics" class="section level2">
<h2 class="hasAnchor">
<a href="#computing-f2-statistics" class="anchor"></a>Computing f2 statistics</h2>
<p>If you’re not on O2, or want use different samples or populations, you first have to compute f2 statistics from genotype data.</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb20-1" data-line-number="1">my_f2_dir =<span class="st"> 'store/f2data/here/'</span></a>
<a class="sourceLine" id="cb20-2" data-line-number="2">pops =<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">'Denisova.DG'</span>,</a>
<a class="sourceLine" id="cb20-3" data-line-number="3">         <span class="st">'Altai_Neanderthal.DG'</span>,</a>
<a class="sourceLine" id="cb20-4" data-line-number="4">         <span class="st">'Vindija.DG'</span>,</a>
<a class="sourceLine" id="cb20-5" data-line-number="5">         <span class="st">'Chimp.REF'</span>,</a>
<a class="sourceLine" id="cb20-6" data-line-number="6">         <span class="st">'Mbuti.DG'</span>,</a>
<a class="sourceLine" id="cb20-7" data-line-number="7">         <span class="st">'Russia_Ust_Ishim.DG'</span>,</a>
<a class="sourceLine" id="cb20-8" data-line-number="8">         <span class="st">'Switzerland_Bichon.SG'</span>)</a>
<a class="sourceLine" id="cb20-9" data-line-number="9"></a>
<a class="sourceLine" id="cb20-10" data-line-number="10"><span class="kw"><a href="../reference/extract_f2.html">extract_f2</a></span>(prefix, <span class="dt">outdir =</span> my_f2_dir, <span class="dt">pops =</span> pops)</a></code></pre></div>
<p>This will look for genotype files in <code>packedancestrymap</code> or <code>PLINK</code> format, compute allele frequencies and blocked f2 statistics for all pairs of populations defined in the <code>.ind</code> or <code>.fam</code> file, and write them to <code>outdir</code>.</p>
<p><br></p>
<p>Now you should be able to run the same examples as before using your own f2 statistics.</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb21-1" data-line-number="1">qpg_results =<span class="st"> </span><span class="kw"><a href="../reference/qpgraph.html">qpgraph</a></span>(my_f2_dir, example_graph)</a></code></pre></div>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb22-1" data-line-number="1"><span class="kw"><a href="../reference/plot_graph.html">plot_graph</a></span>(qpg_results<span class="op">$</span>edges)</a></code></pre></div>
<p><img src="admixtools_files/figure-html/unnamed-chunk-22-1.png" width="864" style="display: block; margin: auto;"></p>
<p>The example above will read the f2 data from <code>my_f2_dir</code>. It can be faster to load it into memory first, like so:</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb23-1" data-line-number="1">f2_blocks =<span class="st"> </span><span class="kw"><a href="../reference/f2_from_precomp.html">f2_from_precomp</a></span>(my_f2_dir, <span class="dt">pops =</span> pops)</a>
<a class="sourceLine" id="cb23-2" data-line-number="2"></a>
<a class="sourceLine" id="cb23-3" data-line-number="3">qpg_results =<span class="st"> </span><span class="kw"><a href="../reference/qpgraph.html">qpgraph</a></span>(f2_blocks, example_graph)</a></code></pre></div>
<p><br></p>
<p>With <code>f2_from_geno</code>, you can skip writing data to disk, and read f2 blocks from genotype files directly. This can be useful if the number of populations is not too large:</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb24-1" data-line-number="1">f2_blocks =<span class="st"> </span><span class="kw"><a href="../reference/f2_from_geno.html">f2_from_geno</a></span>(prefix, <span class="dt">pops =</span> pops)</a>
<a class="sourceLine" id="cb24-2" data-line-number="2"></a>
<a class="sourceLine" id="cb24-3" data-line-number="3">qpg_results =<span class="st"> </span><span class="kw"><a href="../reference/qpgraph.html">qpgraph</a></span>(f2_blocks, example_graph)</a></code></pre></div>
<p><br></p>
<div id="arbitrary-populations" class="section level3">
<h3 class="hasAnchor">
<a href="#arbitrary-populations" class="anchor"></a>Arbitrary populations</h3>
<p>What if you decide that a particular sample should be added or removed from a population? With the approach described so far, you would have to go back to the genotype data to get new estimates of f2 for all pairs of the modified population and any other populations. Even if you had computed f2 for all pairs of individuals (rather than for pairs of populations), it would not be possible to combine the f2 statistics from individual pairs into f2 statistics on population pairs formed from these individuals. It <em>is</em> possible, however, to store <em>other</em> statistics for all individuals and individual pairs, which can be combined into estimates of f2 for any populations formed from these individuals. These statistics are simply the mean alternative allele counts (<code>a</code>) and total allele counts (<code>n</code>) for each individual and block, and the mean products of allele counts for all individual pairs (<code>aa</code> and <code>nn</code>).</p>
<p>The upside of this approach is that it allows you to change population definitions however you like and still get very fast results without accessing the genotype data more than once. The downside is that it makes it necessary to store data for all individual pairs, rather than just all population pairs.</p>
<p>The following function extracts data for a set of individuals which can then be combined to get estimates of f2 for any populations:</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb25-1" data-line-number="1">inds =<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">'Chimp.REF'</span>, <span class="st">'Altai_snpAD.DG'</span>, <span class="st">'Vindija_snpAD.DG'</span>,</a>
<a class="sourceLine" id="cb25-2" data-line-number="2">         <span class="st">'S_Mbuti-3.DG'</span>, <span class="st">'B_Mbuti-4.DG'</span>, <span class="st">'S_Mbuti-2.DG'</span>, <span class="st">'S_Mbuti-1.DG'</span>,</a>
<a class="sourceLine" id="cb25-3" data-line-number="3">         <span class="st">'Denisova_snpAD.DG'</span>, <span class="st">'UstIshim_snpAD.DG'</span>, <span class="st">'Bichon.SG'</span>)</a>
<a class="sourceLine" id="cb25-4" data-line-number="4">my_counts_dir =<span class="st"> 'my/counts/dir'</span></a>
<a class="sourceLine" id="cb25-5" data-line-number="5"><span class="kw"><a href="../reference/extract_counts.html">extract_counts</a></span>(prefix, my_counts_dir, inds)</a></code></pre></div>
<p>You can again use <code>f2_from_precomp</code> to load a subset of the extracted data into memory. If the directory you provide contains allele count data rather than f2 statistics, this function will not only read the data, but combine it into f2 statistics for populations that you define. The populations can be defined by providing a vector of individuals and another vector of equal length with population labels.</p>
<p>For example, the following code should return f2 statistics very similar to the f2 statistics in the earlier examples. They will not be exactly identical, because some approximations are necessary when computing f2 statistics this way.</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb26-1" data-line-number="1">pops =<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">'Chimp'</span>, <span class="st">'Altai'</span>, <span class="st">'Vindija'</span>,</a>
<a class="sourceLine" id="cb26-2" data-line-number="2">         <span class="st">'Mbuti'</span>, <span class="st">'Mbuti'</span>, <span class="st">'Mbuti'</span>, <span class="st">'Mbuti'</span>,</a>
<a class="sourceLine" id="cb26-3" data-line-number="3">         <span class="st">'Denisova'</span>, <span class="st">'Russia'</span>, <span class="st">'Switzerland'</span>)</a>
<a class="sourceLine" id="cb26-4" data-line-number="4">f2_blocks_v2 =<span class="st"> </span><span class="kw"><a href="../reference/f2_from_precomp.html">f2_from_precomp</a></span>(my_counts_dir, <span class="dt">inds =</span> inds, <span class="dt">pops =</span> pops)</a></code></pre></div>
<p>It’s now easy to test how the inclusion or exclusion of specific samples affects the fit of a model. The following example uses only two Mbuti samples, and combines the two Neanderthal samples into one group.</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb27-1" data-line-number="1">inds_v3 =<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">'Chimp.REF'</span>, <span class="st">'Altai_snpAD.DG'</span>, <span class="st">'Vindija_snpAD.DG'</span>,</a>
<a class="sourceLine" id="cb27-2" data-line-number="2">            <span class="st">'S_Mbuti-2.DG'</span>, <span class="st">'S_Mbuti-1.DG'</span>,</a>
<a class="sourceLine" id="cb27-3" data-line-number="3">            <span class="st">'Denisova_snpAD.DG'</span>, <span class="st">'UstIshim_snpAD.DG'</span>, <span class="st">'Bichon.SG'</span>)</a>
<a class="sourceLine" id="cb27-4" data-line-number="4">pops_v3 =<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">'Chimp'</span>, <span class="st">'Neanderthal'</span>, <span class="st">'Neanderthal'</span>,</a>
<a class="sourceLine" id="cb27-5" data-line-number="5">            <span class="st">'Mbuti'</span>, <span class="st">'Mbuti'</span>,</a>
<a class="sourceLine" id="cb27-6" data-line-number="6">            <span class="st">'Denisova'</span>, <span class="st">'Russia'</span>, <span class="st">'Switzerland'</span>)</a>
<a class="sourceLine" id="cb27-7" data-line-number="7">f2_blocks_v3 =<span class="st"> </span><span class="kw"><a href="../reference/f2_from_precomp.html">f2_from_precomp</a></span>(my_counts_dir, <span class="dt">inds =</span> inds_v3, <span class="dt">pops =</span> pops_v3)</a></code></pre></div>
<p><br></p>
<p>This approach is very flexible, but it gets slow when some populations consist of large numbers of samples. If you find yourself in this situation, you can group individuals into populations and store the combined allele count data for those populations on disk. The following example stores a <code>Mbuti</code> group on disk, and then uses that group, rather than each sample in it, to compute f2 statistics.</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb28-1" data-line-number="1">mbuti =<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">'S_Mbuti-3.DG'</span>, <span class="st">'B_Mbuti-4.DG'</span>, <span class="st">'S_Mbuti-2.DG'</span>, <span class="st">'S_Mbuti-1.DG'</span>)</a>
<a class="sourceLine" id="cb28-2" data-line-number="2"><span class="kw"><a href="../reference/group_samples.html">group_samples</a></span>(my_counts_dir, mbuti, <span class="st">'Mbuti'</span>)</a>
<a class="sourceLine" id="cb28-3" data-line-number="3"></a>
<a class="sourceLine" id="cb28-4" data-line-number="4">inds_v4 =<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">'Chimp.REF'</span>, <span class="st">'Altai_snpAD.DG'</span>, <span class="st">'Vindija_snpAD.DG'</span>, <span class="st">'Mbuti'</span>,</a>
<a class="sourceLine" id="cb28-5" data-line-number="5">            <span class="st">'Denisova_snpAD.DG'</span>, <span class="st">'UstIshim_snpAD.DG'</span>, <span class="st">'Bichon.SG'</span>)</a>
<a class="sourceLine" id="cb28-6" data-line-number="6">f2_blocks_v4 =<span class="st"> </span><span class="kw"><a href="../reference/f2_from_precomp.html">f2_from_precomp</a></span>(my_counts_dir, <span class="dt">inds =</span> inds_v4)</a></code></pre></div>
<p>Data from these groups can be deleted like this:</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb29-1" data-line-number="1"><span class="kw"><a href="../reference/delete_groups.html">delete_groups</a></span>(my_counts_dir, <span class="st">'Mbuti'</span>)</a></code></pre></div>
<p><br></p>
</div>
</div>
<div id="model-robustness" class="section level2">
<h2 class="hasAnchor">
<a href="#model-robustness" class="anchor"></a>Model robustness</h2>
<p>One of the advantages of being able to evaluate models quickly is that it becomes easier to test their robustness. For each <code>qp</code> function, there is a function which tests robustness by resampling SNPs (<code>resample_snps</code>), and another function which tests robustness by resampling individuals (<code>resample_inds</code>).</p>
<div id="resampling-snps" class="section level3">
<h3 class="hasAnchor">
<a href="#resampling-snps" class="anchor"></a>Resampling SNPs</h3>
<p>The subsampling of SNPs in blocks (sepcifically block jackknife) is already used throughout all AdmixTools programs to compute standard erorrs. Here, the <code>resample_snps</code> functions generalize this approach in two ways. First, they evaluate and returns <em>all</em> model parameters for each set of resampled SNP blocks. Second, they provide the option to do bootstrap resampling (resampling blocks with replacement while keeping the total number of blocks fixed) rather than jackknife resampling (leaving one block out at a time). The advantage of bootstrap over jackknife resampling is that bootstrap resampling is less likely to underestimate the true variability in the presence of a few, large outliers. The disadvantage is that it is inherently stochastic and doesn’t give the same results each time. Bootstrapping also makes it necessary to evaluate the whole model a large number of times, while jackknifing can be much faster, at least when computing only simple statistics.</p>
<p>Note that the bootstrap and jackknife resampling distributions are on different scales: Bootstrap standard errors are the square root of the sampling variance, whereas jackknife standard errors are the square root of <strong>n times</strong> the sampling variance.</p>
<p>In following example, 1000 models with resampled SNP blocks are evaluated, and a histogram of the likelihood scores is plotted.</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb30-1" data-line-number="1">snpres =<span class="st"> </span><span class="kw"><a href="../reference/resample_snps.html">qpgraph_resample_snps</a></span>(example_f2_blocks, <span class="dt">graph =</span> example_graph, <span class="dt">boot =</span> <span class="dv">1000</span>)</a>
<a class="sourceLine" id="cb30-2" data-line-number="2"><span class="kw"><a href="https://rdrr.io/r/graphics/hist.html">hist</a></span>(snpres<span class="op">$</span>score, <span class="dv">100</span>)</a></code></pre></div>
</div>
<div id="resampling-individuals" class="section level3">
<h3 class="hasAnchor">
<a href="#resampling-individuals" class="anchor"></a>Resampling individuals</h3>
<p>We can also test how robust a model is to changes in the individuals that make up a population. The <code>resample_inds</code> functions evaluate every model that results from excluding one individual, for each individual in populations with at least two individuals.</p>
<div class="sourceCode" id="cb31"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb31-1" data-line-number="1">pops =<span class="st"> </span><span class="kw">get_leafnames</span>(example_igraph)[<span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="dv">1</span><span class="op">:</span><span class="dv">3</span>, <span class="kw"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="dv">4</span>,<span class="dv">4</span>), <span class="dv">5</span><span class="op">:</span><span class="dv">7</span>)]</a>
<a class="sourceLine" id="cb31-2" data-line-number="2">indres =<span class="st"> </span><span class="kw"><a href="../reference/resample_inds.html">qpgraph_resample_inds</a></span>(my_counts_dir, <span class="dt">inds =</span> inds, <span class="dt">pops =</span> pops, <span class="dt">graph =</span> example_graph)</a>
<a class="sourceLine" id="cb31-3" data-line-number="3"><span class="kw">ggplot</span>(indres, <span class="kw">aes</span>(score, score)) <span class="op">+</span><span class="st"> </span><span class="kw">geom_text</span>(<span class="kw">aes</span>(<span class="dt">label =</span> ind))</a></code></pre></div>
<p>For populations with many individuals, this can be used to compute jackknife standard errors for statistics of that population.</p>
<p><br></p>
</div>
</div>
<div id="finding-graphs-with-good-fits" class="section level2">
<h2 class="hasAnchor">
<a href="#finding-graphs-with-good-fits" class="anchor"></a>Finding graphs with good fits</h2>
<p>Another advantage of being able to quickly evaluate a single model using precomputed f-statistics is that we can evaluate many different graphs in order to find graph topologies with good fits.</p>
<p><br></p>
<p>The function <code>find_graphs</code> generates and evaluates <code>numgraphs</code> admixture graphs in <code>numgen</code> iterations across <code>numrep</code> independent repeats to find well fitting admixture graphs.</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb32-1" data-line-number="1">opt_results =<span class="st"> </span><span class="kw"><a href="../reference/find_graphs.html">find_graphs</a></span>(my_f2_dir, pops, <span class="dt">outpop =</span> pops[<span class="dv">1</span>], <span class="dt">numrep =</span> <span class="dv">200</span>,</a>
<a class="sourceLine" id="cb32-2" data-line-number="2">                          <span class="dt">numgraphs =</span> <span class="dv">100</span>, <span class="dt">numgen =</span> <span class="dv">20</span>, <span class="dt">numsel =</span> <span class="dv">5</span>, <span class="dt">numadmix =</span> <span class="dv">3</span>)</a></code></pre></div>
<p><br></p>
<p>Once that is done, the following commands will extract the best fitting model overall, and the best fitting model from each independent repeat.</p>
<div class="sourceCode" id="cb33"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb33-1" data-line-number="1">winner =<span class="st"> </span>opt_results <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">top_n</span>(<span class="dv">1</span>, <span class="op">-</span><span class="kw"><a href="https://rdrr.io/r/base/jitter.html">jitter</a></span>(score))</a>
<a class="sourceLine" id="cb33-2" data-line-number="2">winners =<span class="st"> </span>opt_results <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">group_by</span>(run) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">top_n</span>(<span class="dv">1</span>, <span class="op">-</span><span class="kw"><a href="https://rdrr.io/r/base/jitter.html">jitter</a></span>(score)) <span class="op">%&gt;%</span><span class="st"> </span>ungroup</a></code></pre></div>
<div class="sourceCode" id="cb34"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb34-1" data-line-number="1">winner<span class="op">$</span>score[[<span class="dv">1</span>]]</a></code></pre></div>
<pre><code>## [1] 4.009599</code></pre>
<div class="sourceCode" id="cb36"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb36-1" data-line-number="1"><span class="kw"><a href="../reference/plot_graph.html">plot_graph</a></span>(winner<span class="op">$</span>edges[[<span class="dv">1</span>]])</a></code></pre></div>
<p><img src="admixtools_files/figure-html/unnamed-chunk-35-1.png" width="864" style="display: block; margin: auto;"><br></p>
<div id="parallelization" class="section level3">
<h3 class="hasAnchor">
<a href="#parallelization" class="anchor"></a>Parallelization</h3>
<p>Depending on the input parameters, <code>optimize_admixturegraph</code> can take a long time to run. With the parameters above, 420,000 admixture graphs (200 * 100 * (20+1)) will be generated and evaluated. Thanks to the function <a href="https://www.rdocumentation.org/packages/furrr/versions/0.1.0/topics/future_map"><code>future_map</code></a> from the <a href="https://github.com/DavisVaughan/furrr"><code>furrr</code></a> package, this can be sped up by parallelizing across the independent repeats. The function <a href="https://www.rdocumentation.org/packages/future/versions/1.15.1/topics/plan"><code><a href="https://rdrr.io/pkg/future/man/plan.html">future::plan</a></code></a> can be called to specify the details of the parallelization. This can be used to parallelize across CPU cores or across nodes on a compute cluster.</p>
<p>Setting it up like this will make it run multithreaded:</p>
<div class="sourceCode" id="cb37"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb37-1" data-line-number="1">future<span class="op">::</span><span class="kw"><a href="https://rdrr.io/pkg/future/man/plan.html">plan</a></span>(<span class="st">'multiprocess'</span>)</a></code></pre></div>
<p><br></p>
<p>On the O2 cluster, the following command will set up parallelization across compute nodes.</p>
<div class="sourceCode" id="cb38"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb38-1" data-line-number="1">future<span class="op">::</span><span class="kw"><a href="https://rdrr.io/pkg/future/man/plan.html">plan</a></span>(<span class="kw">tweak</span>(batchtools_slurm, <span class="dt">workers =</span> <span class="dv">50</span>,</a>
<a class="sourceLine" id="cb38-2" data-line-number="2">                   <span class="dt">resources=</span><span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="dt">ncpus =</span> <span class="dv">1</span>, <span class="dt">memory =</span> <span class="dv">1024</span>,</a>
<a class="sourceLine" id="cb38-3" data-line-number="3">                                  <span class="dt">walltime =</span> <span class="dv">10</span><span class="op">*</span><span class="dv">60</span><span class="op">*</span><span class="dv">60</span>, <span class="dt">partition =</span> <span class="st">'short'</span>)))</a></code></pre></div>
<p>This specifies that up to 50 jobs should be run at a time, with each one requesting one CPU, 1024 MB of memory, and 10 hours on the <code>short</code> partition.</p>
<p>This requires the R package <code>future.batchtools</code> and a batchtools template file in the working directory, such as this one: <code>/n/groups/reich/robert/projects/admixprograms/batchtools.slurm.tmpl</code>.</p>
<p>With this setup the <code>find_graphs</code> function will submit each of the 200 repeats as a separate job.</p>
<p>As it will still take a while for this to finish, it is a good idea to submit this as one job which calls an R script. That R script will in turn spawn 200 new jobs and wait for them to finish and return their results.</p>
<p>The R script could look like this.</p>
<div class="sourceCode" id="cb39"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb39-1" data-line-number="1"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(admixtools)</a>
<a class="sourceLine" id="cb39-2" data-line-number="2"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(future.batchtools)</a>
<a class="sourceLine" id="cb39-3" data-line-number="3"></a>
<a class="sourceLine" id="cb39-4" data-line-number="4">future<span class="op">::</span><span class="kw"><a href="https://rdrr.io/pkg/future/man/plan.html">plan</a></span>(<span class="kw">tweak</span>(batchtools_slurm, <span class="dt">workers=</span><span class="dv">50</span>,</a>
<a class="sourceLine" id="cb39-5" data-line-number="5">                   <span class="dt">resources=</span><span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="dt">ncpus =</span> <span class="dv">1</span>, <span class="dt">memory=</span><span class="dv">1024</span>,</a>
<a class="sourceLine" id="cb39-6" data-line-number="6">                                  <span class="dt">walltime=</span><span class="dv">10</span><span class="op">*</span><span class="dv">60</span><span class="op">*</span><span class="dv">60</span>, <span class="dt">partition=</span><span class="st">'short'</span>)))</a>
<a class="sourceLine" id="cb39-7" data-line-number="7"></a>
<a class="sourceLine" id="cb39-8" data-line-number="8">pops =<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">'popA'</span>, <span class="st">'popB'</span>, <span class="st">'popC'</span>, <span class="st">'popD'</span>)</a>
<a class="sourceLine" id="cb39-9" data-line-number="9">opt_results =<span class="st"> </span><span class="kw"><a href="../reference/find_graphs.html">find_graphs</a></span>(<span class="st">'/my/f2/dir/'</span>, pops, <span class="dt">outpop =</span> pops[<span class="dv">1</span>], <span class="dt">numrep =</span> <span class="dv">200</span>,</a>
<a class="sourceLine" id="cb39-10" data-line-number="10">                          <span class="dt">numgen =</span> <span class="dv">20</span>, <span class="dt">numgraphs =</span> <span class="dv">100</span>, <span class="dt">numadmix =</span> <span class="dv">3</span>, <span class="dt">verbose =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb39-11" data-line-number="11"></a>
<a class="sourceLine" id="cb39-12" data-line-number="12"><span class="kw"><a href="https://rdrr.io/r/base/save.html">save</a></span>(opt_results, <span class="dt">file=</span><span class="st">'opt_results.RData'</span>)</a></code></pre></div>
<p>It could be in a file called <code>opt_graphs.Rscript</code> and be run like this, or submitted as a job.</p>
<div class="sourceCode" id="cb40"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb40-1" data-line-number="1">Rscript opt_graphs.Rscript</a></code></pre></div>
<p>It takes more time to evaluate larger graphs, and in particular graphs with more admixture nodes. It’s probably a good idea to start with a small number of repeats, generations, and graphs per generation to get a sense of the runtime before scaling it up.</p>
<p><br></p>
</div>
</div>
<div id="summarizing-graphs" class="section level2">
<h2 class="hasAnchor">
<a href="#summarizing-graphs" class="anchor"></a>Summarizing graphs</h2>
<p><br></p>
<blockquote>
<p><em>All models are wrong, but some are useful.</em> — George Box</p>
</blockquote>
<p><br></p>
<blockquote>
<p><em>All good models are alike; each bad model is bad in its own way.</em> — Leo Tolstoy</p>
</blockquote>
<p><br></p>
<p>For any set of populations there may be many graphs which can explain the data about equally well. Rather than declaring one of these models as the correct model, it may be more useful to find features that are shared between all models with good fits. The following function attempts to find such features by summarizing a set of graphs. It counts how often each population triple occurs in which configuration across all graphs.</p>
<div class="sourceCode" id="cb41"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb41-1" data-line-number="1">triples =<span class="st"> </span><span class="kw"><a href="../reference/summarize_triples.html">summarize_triples</a></span>(winners)</a></code></pre></div>
<div class="sourceCode" id="cb42"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb42-1" data-line-number="1">triples <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">arrange</span>(<span class="op">-</span>clade) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">slice</span>(<span class="dv">1</span>)</a></code></pre></div>
<pre><code>## # A tibble: 1 x 14
##   name1 name2 name3 numgraphs   x13   x23   x31   x32 clade   x12   x21 toptopo
##   &lt;chr&gt; &lt;chr&gt; &lt;chr&gt;     &lt;int&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;chr&gt;  
## 1 Russ… Swit… Deni…       200 0.005 0.245 0.505  0.38 0.345  0.88 0.505 011111 
## # … with 2 more variables: toptopocnt &lt;int&gt;, topos &lt;list&gt;</code></pre>
<p>The output for this population triple (1: <code>Rus</code>, 2: <code>Swi</code>, 3: <code>Den</code>) can be read like this:</p>
<ul>
<li>
<code>numgraphs</code>: 200 graphs were compared</li>
<li>
<code>clade</code>: In 34.5% of all graphs <code>Rus</code> and <code>Swi</code> form a clade with respect to <code>Den</code>
</li>
<li>
<code>x13</code>: In 0.5% of all graphs <code>Rus</code> is closer to <code>Den</code> than <code>Swi</code> is to <code>Den</code>, with ancestors of <code>Rus</code> admixing into <code>Den</code>
</li>
<li>
<code>x31</code>: In 50.5% of all graphs <code>Rus</code> is closer to <code>Den</code> than <code>Swi</code> is to <code>Den</code>, with ancestors of <code>Den</code> admixing into <code>Rus</code>
</li>
<li>
<code>x23</code>: In 24.5% of all graphs <code>Swi</code> is closer to <code>Den</code> than <code>Rus</code> is to <code>Den</code>, with ancestors of <code>Swi</code> admixing into <code>Den</code>
</li>
<li>
<code>x32</code>: In 38.0% of all graphs <code>Swi</code> is closer to <code>Den</code> than <code>Rus</code> is to <code>Den</code>, with ancestors of <code>Den</code> admixing into <code>Swi</code>
</li>
<li>
<code>toptopo</code>: The most common topology for this triple across all graphs. <code>011111</code> specifies a topology where condition <code>x13</code> is not satisfied, but conditions <code>x23</code>, <code>x31</code>, <code>x32</code>, <code>x12</code>, and <code>x21</code> are satisfied. A topology starting with <code>0000</code> is one where the first two populations form a clade.</li>
<li>
<code>toptopocnt</code>: The number of times <code>toptopo</code> was observed</li>
<li>
<code>topos</code>: The number of times each topology was observed</li>
</ul>
<p><br></p>
</div>
<div id="finding-valid-qpadm-models" class="section level2">
<h2 class="hasAnchor">
<a href="#finding-valid-qpadm-models" class="anchor"></a>Finding valid qpAdm models</h2>
<p>Every admixture graph maps to a specific set of valid qpAdm models. The function <code>qpadm_models</code> lists all valid qpAdm models for a graph. Models which are contained within larger valid models are not shown. The number of valid qpAdm models can be very large for big graphs, so you should only run this on small graphs.</p>
<div class="sourceCode" id="cb44"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb44-1" data-line-number="1">mygraph =<span class="st"> </span>winners <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">slice</span>(<span class="dv">6</span>) <span class="op">%$%</span><span class="st"> </span>igraph <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">pluck</span>(<span class="dv">1</span>)</a>
<a class="sourceLine" id="cb44-2" data-line-number="2"><span class="kw"><a href="../reference/plot_graph.html">plot_graph</a></span>(mygraph)</a></code></pre></div>
<p><img src="admixtools_files/figure-html/unnamed-chunk-43-1.png" width="864" style="display: block; margin: auto;"></p>
<div class="sourceCode" id="cb45"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb45-1" data-line-number="1"><span class="kw"><a href="../reference/qpadm_models.html">qpadm_models</a></span>(mygraph, <span class="dt">add_outgroup =</span> <span class="ot">TRUE</span>, <span class="dt">nested =</span> <span class="ot">FALSE</span>, <span class="dt">abbr =</span> <span class="dv">3</span>)</a></code></pre></div>
<pre><code>## # A tibble: 3 x 3
##   target left    right      
##   &lt;chr&gt;  &lt;chr&gt;   &lt;chr&gt;      
## 1 Den    Alt,Mbu Chi,Rus,Swi
## 2 Den    Alt,Vin Chi,Rus,Swi
## 3 Den    Mbu,Vin Chi,Rus,Swi</code></pre>
<p>The only qpAdm models which are valid under this graph have <code>Den</code> as target and <code>Chi</code>, <code>Rus</code>, and <code>Swi</code> as right populations.</p>
<p>Valid qpAdm models need to satisfy the following criteria:</p>
<ul>
<li>There have to be more right populations than left populations</li>
<li>The left populations should not form a clade with respect to any right population. This means that a qpgraph outgroup is not an informative right population, but it can be included anyway, with <code>add_outgroup</code>.</li>
<li>Each set of left populations which forms a source for the target population has to form a clade with target at the exclusion of each right population. (Note: Check if that’s correct and if it can be stated in a better way.)</li>
</ul>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#qp3pop">qp3Pop</a></li>
      <li><a href="#qpdstat">qpDstat</a></li>
      <li><a href="#qpadm">qpAdm</a></li>
      <li><a href="#qpgraph">qpGraph</a></li>
      <li><a href="#comparing-results-to-admixtools">Comparing results to AdmixTools</a></li>
      <li><a href="#computing-f2-statistics">Computing f2 statistics</a></li>
      <li><a href="#model-robustness">Model robustness</a></li>
      <li><a href="#finding-graphs-with-good-fits">Finding graphs with good fits</a></li>
      <li><a href="#summarizing-graphs">Summarizing graphs</a></li>
      <li><a href="#finding-valid-qpadm-models">Finding valid qpAdm models</a></li>
      </ul>
</div>
      </div>

</div>



      <footer><div class="copyright">
  <p>Developed by Robert Maier, Nick Patterson.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.4.1.</p>
</div>

      </footer>
</div>

  
<script src="https://cdnjs.cloudflare.com/ajax/libs/docsearch.js/2.6.1/docsearch.min.js" integrity="sha256-GKvGqXDznoRYHCwKXGnuchvKSwmx9SRMrZOTh2g4Sb0=" crossorigin="anonymous"></script><script>
  docsearch({
    
    
    apiKey: '',
    indexName: 'admixtools',
    inputSelector: 'input#search-input.form-control',
    transformData: function(hits) {
      return hits.map(function (hit) {
        hit.url = updateHitURL(hit);
        return hit;
      });
    }
  });
</script>
</body>
</html>

---
title: "Simulations"
author: "Robert Maier"
date: "`r Sys.Date()`"
output:
  rmarkdown::html_vignette:
    toc: true
    toc_depth: 1
vignette: >
  %\VignetteIndexEntry{Simulations}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
---

**Under construction**

*ADMIXTOOLS 2* makes it easy to simulate genetic data under a given admixture graph with the help of [msprime](https://msprime.readthedocs.io/en/stable/). This requires a python installation with the *msprime* module.

```{r, warning=FALSE, message=FALSE}
library(tidyverse)
library(admixtools)
```

```{r}
set.seed(1234)
g = random_admixturegraph(6, 2, outpop = 'A')
plotly_graph(g)
```

```{r, eval = F}
outprefix = '/my/outdir/prefix'
msprime_sim(g, outprefix, nsnps = 1e5, ind_per_pop = 100, numcores = 8)
```

```{r, echo = F, eval = T}
outprefix = '~/Downloads/msprime_markdown'
```
```{r, echo = F, eval = F}
msprime_sim(g, outprefix, nsnps = 1e5, ind_per_pop = 100, run = '/Users/robert/anaconda2/bin/python', numcores = 8)
```

```{r}
f2_blocks = f2_from_geno(outprefix, verbose = FALSE)
```

The last two steps can also be combined into one step with the `f2_from_graph()` function.
```{r, eval = F}
f2_blocks = f2_from_graph(g, nsnps = 1e5, ind_per_pop = 100, numcores = 8)
```

As expected, the graph under which the data were simulated has a very good fit:

```{r}
qpgraph(f2_blocks, g)$score
```

An admixture graph only captures some of the parameters which determine the full demographic history (particularly when is hasn't been fitted and there is just a topology). Therefore, some assumptions are being made when simulations are generated by `msprime_sim()`:

* Effective population size and mutation rates are constant
* Time points of branch splits and admixture events are proportional to the position on the y-axis of the graph representation created by `plotly_graph()`
* All admixture proportions are 50%
* All SNPs are independent. This is achieved by simulating a single SNP at a time, and is justified by the fact that the block-jackknife/bootstrap method which is used throughout *ADMIXTOOLS 2* adequately controls for the effects of linked SNPs.

Some of these assumptions are not realistic and are only here for convenience and to reduce the simulation run time. Feel free to e-mail me suggestions for more sensible defaults.


If you want to override any of the default assumptions, you can do so in three ways:

1. By supplying a fitted graph to the `msprime_sim()` function
  
    In this case, admixture weights of the fitted graph will be directly translated into simulated admixture proportions. Fitted drift lengths represent an unknown combination of time and effective population size. `msprime_sim()` will simulated fitted drift lengths by adjusting effective population sizes of the relevant populations.
  
2. By adjusting the `neff`, `time`, or `ind_per_pop` parameters of the `msprime_sim()` function

    As in this example:
  
    ```{r, eval = F}
    msprime_sim(g, outprefix, nsnps = 1e5,
                # neff should be specified for all nodes
                neff = c(R = 1e4, Rr = 1000, A = 10, B = 100, C = 1000, ...),
                # time in generations (not years) should be specified for all nodes
                time = c(R = 10000, Rr = 9000, A = 2000, B = 0, C = 100, ...),
                # ind_per_pop should be specified for all leaf nodes
                ind_per_pop = c(A = 10, B = 100, D = 10, ...)
                )
    ```

3. By manually modifying the msprime simulation python script.

    `msprime_sim()` will create a file `[outprefix].py` which may need to be modified before running the simulation.





